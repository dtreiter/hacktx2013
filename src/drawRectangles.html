<HTML>
<head>
</head>
<script src="http://cwilso.github.io/AudioContext-MonkeyPatch/AudioContextMonkeyPatch.js"></script>
<script src="./js/easel.js"></script>
<script src="./js/pitchdetect.js"></script>
<script>
				var mySong = {
								startTime : 0.56,
                bpm :  94.79,
                title : "Twinkle Twinkle Little Star",
                notes : [["C",1],["C",1],["G",1],["G",1],["A",1],["A",1],["G",2],["F",1],["F",1],["E",1],["E",1],["D",1],["D",1],["C",2],
						 ["G",1],["G",1],["F",1],["F",1],["E",1],["E",1],["D",2],["G",1],["G",1],["F",1],["F",1],["E",1],["E",1],["D",2],
						 ["C",1],["C",1],["G",1],["G",1],["A",1],["A",1],["G",2],["F",1],["F",1],["E",1],["E",1],["D",1],["D",1],["C",2]]
				};
	var run_game = false;
        var FRAME_RATE = 60;
        var INIT_X = 100;
        var VERT_SPACING;
        var BEAT_LENGTH_SIZE = 120;
        var NUM_NOTES = 7;
        var NOTE_TOL = 20;

        var canvas, width, height;
      	var notes;
        var stage;
      	var userPitchLine;
      	var lineX;
      	var userPitch;
      	var userPitchWasUndefined;
	var rects;
        var markerX;
	var highlighted;

        function init() {
            canvas = document.getElementById('note-cont');
            width = canvas.width;
            height = canvas.height;
	    userPitchLine = new createjs.Shape();
            userPitchLine.graphics.setStrokeStyle(1).beginStroke("black").moveTo(100,100);
            markerX = 1/4*width;
	    toggleLiveInput();
		
            VERT_SPACING = height / NUM_NOTES;
            stage = new createjs.Stage(canvas);
            createjs.Ticker.setFPS(FRAME_RATE);

            var curTimeMarker = new createjs.Shape();
            lineX = markerX;
            var g = curTimeMarker.graphics;
            g.beginFill("#FFF");
            g.drawRect(markerX, 0, 1, height);
            g.endFill();
            stage.addChild(curTimeMarker);

            rects = new Array();
            var beat = 0;
            for (var i = 0; i < mySong.notes.length; i++) {
            	note = mySong.notes[i];
              var noteLength = note[1];
              var y = getYCoordFromNote(note[0]); // pitch
              var x = getXCoordFromBeat(beat);
              var width = noteLength * BEAT_LENGTH_SIZE - 2;
              var height = NOTE_TOL;
              rects.push(new createjs.Rectangle(0, y, width, height));
	      rects[i].mahX = x;
              beat += noteLength; // offset next note starting beat
            }
	    highlighted = Array(rects.length);
            console.log(rects);

      	    notes = [];
            for (var i = 0; i < rects.length; i++) {
              var s = drawRectangle(rects[i], "#F00");
	      notes.push(s);
	      notes[i].x = rects[i].mahX;
              stage.addChild(s);
            }

              stage.addChild(userPitchLine);
      		stage.update();
      		createjs.Ticker.addListener(window);
           
        }

      	function tick() {
		if(run_game) { 
			var moveSpeed = 2 * BEAT_LENGTH_SIZE / FRAME_RATE;
			var y_val = canvas.height - (userPitch / 2);
			var userNote = noteStrings[noteFromPitch(userPitch) % 12];
			for(var i = 0; i < notes.length; i++) {
				notes[i].x -= moveSpeed;
				var intersectingLine = (markerX > notes[i].x && markerX < (notes[i].x + rects[i].width));
				var intune = mySong.notes[i][0] == userNote;
				if( !highlighted[i] && intersectingLine ) { 
					highlighted[i] = true;
					notes[i].graphics.clear().beginFill("#0FF").drawRect(rects[i].x, rects[i].y, rects[i].width, rects[i].height).endFill();
				}
				if( highlighted[i] && !intersectingLine ) {
					highlighted[i] = false;
					notes[i].graphics.clear().beginFill("#F00").drawRect(rects[i].x, rects[i].y, rects[i].width, rects[i].height).endFill();
				}
				if(intune && highlighted[i]){
					notes[i].graphics.clear().beginFill("#0F0").drawRect(rects[i].x, rects[i].y, rects[i].width, rects[i].height).endFill();
				}
			}
			userPitchLine.x -= moveSpeed;
			lineX += moveSpeed;
			if(userPitch !== undefined){
				userPitchLine.graphics.lineTo(lineX, y_val);
				console.log( noteStrings[noteFromPitch(userPitch) % 12] );
			} else {
				// userPitchLine.graphics.moveTo(lineX, canvas.height);
				userPitchWasUndefined = true;
			}
		}
      		stage.update();
      	}

        function getXCoordFromBeat(beat) {
          var HORIZ_OFFSET = 2/9 * canvas.width;
          return beat * BEAT_LENGTH_SIZE + HORIZ_OFFSET;
        }

        function getYCoordFromNote(note){
          var pos;
          var OFFSET = 2/9 * canvas.height;
          console.log(height);
          if (note == "C") {
            pos = 6;
          } else if (note == "D") {
            pos = 5;
          } else if (note == "E") {
            pos = 4;
          } else if (note == "F") {
            pos = 3;
          } else if (note == "G") {
            pos = 2;
          } else if (note == "A") {
            pos = 1;
          }  else if (note == "B") {
            pos = 0;
          } else {
            console.log("Invalid note");
            return null;
          }

          return pos * VERT_SPACING + OFFSET;
        }

        function drawRectangle(rect, color) {
	    var s = new createjs.Shape();
            var g = s.graphics;

            g.beginStroke("#000");
            g.beginFill(color);
            g.drawRect(rect.x, rect.y, rect.width, rect.height);
            g.endFill();

            return s;
	}

</script>

<body onload="init();">
	<button onclick="run_game = true;">Start!</button>  
  <br />
  <input type="range" min="16000" max="19000" onchange="window.tolerance = this.value"/>
  <br />
	<canvas id="note-cont" style="background:#666;" width="1600" height="900"></canvas>
</body>

</HTML>
