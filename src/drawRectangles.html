<HTML>
<head>
</head>
<script src="http://cwilso.github.io/AudioContext-MonkeyPatch/AudioContextMonkeyPatch.js"></script>
<script src="./js/easel.js"></script>
<script src="./js/pitchdetect.js"></script>
<script>
	var mySong = {
		bpm : 120,
		title : "Song name",
		notes : [["C",2], ["E",4], ["D",3], ["B", 3]]
	};
        var INIT_X = 100;
        var VERT_SPACING = 50;
        var BEAT_LENGTH = 30;

        var canvas, width, height;
      	var notes;
        var stage;
	var userPitch;
	var userPitchLine;
	var lineX = 200;
        function init() {
            canvas = document.getElementById('note-cont');
            width = canvas.width;
            height = canvas.height;
		userPitchLine = new createjs.Shape();
		userPitchLine.graphics.setStrokeStyle(1).beginStroke("black").moveTo(100,100).lineTo(200,200);
		
            var rects = new Array();
            var beat = 0;
            for (var i = 0; i < mySong.notes.length; i++) {
            	note = mySong.notes[i];
              var noteLength = note[1];
              var y = getYCoordFromNote(note[0]); // pitch
              var x = getXCoordFromBeat(beat);
              var width = noteLength * BEAT_LENGTH;
              var height = 10;
              rects.push(new createjs.Rectangle(x, y, width, height));
              beat += noteLength; // offset next note starting beat
            }
            console.log(rects);

            stage = new createjs.Stage(canvas);

      	    notes = [];
            for (var i = 0; i < rects.length; i++) {
              var s = drawRectangle(rects[i]);
          		notes.push(s);
              stage.addChild(s);
            }

              stage.addChild(userPitchLine);
      		stage.update();
      		createjs.Ticker.addListener(window);
           
        }

	function tick() {
		var moveSpeed = 1 * (mySong.bpm / 120);
		for(var i = 0; i < notes.length; i++) {
			notes[i].x -= moveSpeed;
		}
		userPitchLine.x -= moveSpeed;
		lineX += moveSpeed;
		if(userPitch !== undefined){
			userPitchLine.graphics.lineTo(lineX, userPitch / 8);
//			console.log(userPitch);
		}
		stage.update();
	}

        function getXCoordFromBeat(beat) {
          var HORIZ_OFFSET = 200;
          return beat * BEAT_LENGTH + HORIZ_OFFSET;
        }

        function getYCoordFromNote(note){
          var pos;
          var OFFSET = 100;
          if (note == "C") {
            pos = 6;
          } else if (note == "D") {
            pos = 5;
          } else if (note == "E") {
            pos = 4;
          } else if (note == "F") {
            pos = 3;
          } else if (note == "G") {
            pos = 2;
          } else if (note == "A") {
            pos = 1;
          }  else if (note == "B") {
            pos = 0;
          } else {
            console.log("Invalid note");
            return null;
          }

          // * VERT_SPACING
          return pos * VERT_SPACING + OFFSET;
        }

        function drawRectangle(rect) {
      			var s = new createjs.Shape();
            var g = s.graphics;

            g.beginStroke("#000");
            g.beginFill("#F00");
            g.drawRect(rect.x, rect.y, rect.width, rect.height);
            g.endFill();

            return s;
	}

</script>

<body onload="init();">
	<button onclick="toggleLiveInput()">Start!</button>
	<canvas id="note-cont" style="background:#666;" width="900" height="900"></canvas>
	<input type="range" min="16000" max="19000" onchange="window.tolerance = this.value"/>
</body>

</HTML>
